# 视频录制系统

这是一个基于C++和现代Web技术开发的视频录制系统，专为连续稳定的视频流录制而设计。

## 系统特性

### 核心功能
- 🎥 **双路RTSP流录制**: 支持同时录制两路视频流
- 📹 **自动分段录制**: 可配置的时间分段，便于文件管理
- 💾 **智能存储管理**: 自动清理过期文件，保持存储空间
- 🔧 **实时配置**: 通过Web界面实时调整录制参数
- 📊 **状态监控**: 实时显示录制状态和系统信息
- 🛡️ **异常恢复**: 自动重启异常中断的录制进程

### 技术特点
- **高性能**: 使用FFmpeg进行硬件加速录制
- **低资源消耗**: 优化的内存和CPU使用
- **工业级稳定性**: 多线程设计，异常处理完善
- **现代UI**: Bootstrap5 + 响应式设计
- **RESTful API**: 标准化的接口设计

## 系统要求

### 硬件要求
- CPU: ARM64或x86_64架构
- 内存: 至少512MB可用内存
- 存储: TF卡或其他存储设备，推荐32GB以上
- 网络: 千兆网口，支持RTSP协议

### 软件依赖
- Linux操作系统（推荐Ubuntu 18.04+）
- FFmpeg 4.0+
- GCC 7.0+ 支持C++17
- 网络连接

## 快速开始

### 1. 编译安装

```bash
# 编译程序
make

# 安装并创建必要目录
sudo make install
```

### 2. 配置系统

首次运行会自动创建默认配置文件 `config.json`，您可以手动编辑：

```json
{
    "rtsp_url_1": "rtsp://192.168.1.100:554/stream1",
    "rtsp_url_2": "rtsp://192.168.1.100:554/stream2", 
    "save_path_1": "/mnt/tfcard/videos1",
    "save_path_2": "/mnt/tfcard/videos2",
    "segment_time": 600,
    "dual_stream": true
}
```

### 3. 启动系统

```bash
# 前台运行（用于调试）
make run

# 后台运行（生产环境）
make daemon

# 停止后台运行
make stop
```

### 4. 访问Web界面

打开浏览器访问：`http://192.168.1.36:8060`

## 使用指南

### Web界面功能

#### 系统状态面板
- **录制状态**: 显示当前录制状态，带动态指示器
- **TF卡状态**: 实时监控存储空间
- **录制模式**: 显示单路或双路录制模式
- **运行时间**: 显示当前录制持续时间

#### 录制控制
- **开始录制**: 一键启动录制，支持双路同时录制
- **停止录制**: 安全停止录制进程
- **状态监控**: 每2秒自动刷新系统状态

#### 配置管理
- **RTSP地址配置**: 支持两路独立的RTSP流地址
- **保存路径配置**: 自定义录制文件保存位置
- **分段时间设置**: 60秒到3600秒可调
- **双路开关**: 启用/禁用第二路录制

#### 文件管理
- **文件列表**: 显示所有录制文件
- **一键刷新**: 实时更新文件列表
- **存储统计**: 显示文件数量统计

#### 系统日志
- **实时日志**: 显示系统运行日志
- **分类显示**: 成功、错误、警告信息分类
- **自动滚动**: 新日志自动滚动到视野内

### API接口

系统提供RESTful API接口：

#### 获取系统状态
```http
GET /api/status
```

#### 开始录制
```http
POST /api/start
```

#### 停止录制
```http
POST /api/stop
```

#### 更新配置
```http
POST /api/config
Content-Type: application/json

{
    "rtsp_url_1": "rtsp://192.168.1.100:554/stream1",
    "rtsp_url_2": "rtsp://192.168.1.100:554/stream2",
    "segment_time": 600,
    "dual_stream": true
}
```

#### 获取文件列表
```http
GET /api/files
```

## 系统配置

### 录制参数

| 参数 | 说明 | 默认值 | 范围 |
|------|------|--------|------|
| rtsp_url_1 | 第一路RTSP地址 | rtsp://192.168.1.100:554/stream1 | 有效RTSP URL |
| rtsp_url_2 | 第二路RTSP地址 | rtsp://192.168.1.100:554/stream2 | 有效RTSP URL |
| save_path_1 | 第一路保存路径 | /mnt/tfcard/videos1 | 有效目录路径 |
| save_path_2 | 第二路保存路径 | /mnt/tfcard/videos2 | 有效目录路径 |
| segment_time | 分段时间（秒） | 600 | 60-3600 |
| dual_stream | 双路录制开关 | true | true/false |

### 系统参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| VIDEO_RETENTION_DAYS | 视频保留天数 | 10.0 |
| TF_MOUNT_PATH | TF卡挂载路径 | /mnt/tfcard |
| 服务端口 | Web服务端口 | 8060 |

## 故障排除

### 常见问题

#### 1. 编译失败
```bash
# 检查GCC版本
gcc --version

# 安装必要依赖
sudo apt-get install build-essential
```

#### 2. 无法连接RTSP流
- 检查网络连接
- 验证RTSP地址格式
- 确认摄像头支持RTSP协议

#### 3. 录制文件过大
- 调整分段时间参数
- 配置文件自动清理策略

#### 4. Web界面无法访问
```bash
# 检查程序是否运行
ps aux | grep video_recorder

# 检查端口占用
netstat -tulpn | grep 8060

# 检查防火墙设置
sudo ufw status
```

### 日志分析

系统日志文件位置：
- 运行日志: `recorder.log`
- 系统状态: `recording_status.json`
- 配置文件: `config.json`

### 性能优化

#### 系统级优化
```bash
# 增加文件描述符限制
ulimit -n 4096

# 优化网络参数
echo 'net.core.rmem_max = 268435456' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 268435456' >> /etc/sysctl.conf
```

#### 存储优化
- 使用高速TF卡（Class 10或以上）
- 定期清理过期文件
- 监控磁盘空间使用

## 系统架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Web前端界面    │    │   C++ HTTP服务器  │    │   FFmpeg录制引擎 │
│   (Bootstrap5)  │◄──►│   (httplib)      │◄──►│   (双路录制)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         ▲                        ▲                        ▲
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   配置管理模块   │    │   状态监控模块    │    │   文件管理模块   │
│   (JSON配置)    │    │   (实时状态)     │    │   (自动清理)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 开发指南

### 编译选项
```bash
# 调试版本
make debug

# 发布版本
make

# 清理编译文件
make clean
```

### 代码结构
```
demo/
├── video_recorder.cc    # 主程序源码
├── web/                 # Web前端文件
│   ├── index.html      # 主页面
│   └── app.js          # 前端逻辑
├── Makefile            # 构建配置
└── README.md           # 文档说明
```

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 支持与反馈

如有问题或建议，请联系技术支持。

---

**注意**: 本系统适用于工业环境的连续录制需求，请根据实际环境调整配置参数。 
